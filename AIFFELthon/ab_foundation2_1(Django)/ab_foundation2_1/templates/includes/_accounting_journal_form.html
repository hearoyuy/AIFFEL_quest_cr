{% comment %} templates/includes/_accounting_journal_form.html {% endcomment %}
{% load static %}

{# ì •ì  íŒŒì¼ URLì„ ì €ì¥í•˜ê¸° ìœ„í•œ ìˆ¨ê²¨ì§„ div #}
<div id="static-urls-data" style="display: none;"
     data-no-pdf-preview-text="í‘œì‹œí•  PDF ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤."> {# ê¸°ë³¸ í…ìŠ¤íŠ¸ë¥¼ data ì†ì„±ìœ¼ë¡œ ê´€ë¦¬ #}
</div>

<div id="mainContentArea" class="container mx-auto my-12 px-4 max-w-7xl">

    {# --- PDF ë³´ê¸° ë²„íŠ¼ (position: fixed ì ìš©) --- #}
    <button id="openPdfSidebarBtn" type="button"
            class="fixed top-5 right-5 z-30 px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 flex items-center"
            onclick="showPdf(null)">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M4 2a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2V4a2 2 0 00-2-2H4zm6 2a1 1 0 00-1 1v2a1 1 0 102 0V5a1 1 0 00-1-1zM8 9a1 1 0 00-1 1v4a1 1 0 102 0v-4a1 1 0 00-1-1zm4-4a1 1 0 100 2h2a1 1 0 100-2h-2zm0 3a1 1 0 00-1 1v5a1 1 0 102 0v-5a1 1 0 00-1-1z" clip-rule="evenodd" />
        </svg>
        PDF ë³´ê¸°
    </button>

    <form id="accountingJournalForm" method="post">
        {% csrf_token %}
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-2xl font-bold text-green-700">Accounting Journal Entry</h1>
        </div>

        {# General Information (ì´í•˜ í¼ ë‚´ìš©ì€ ì´ì „ê³¼ ë™ì¼í•˜ì—¬ ìƒëµ) #}
        <div class="bg-white shadow-md rounded-lg mb-6">
            {% include "includes/_general_info_section.html" %}
        </div>

        <div class="bg-white shadow-md rounded-lg mb-6">
            {% include "includes/_transaction_details_section.html" %}
        </div>

        <div class="bg-white shadow-md rounded-lg mb-6">
            {% include "includes/_payment_section.html" %}
        </div>
        {# (í¼ ë‚´ìš© ë) #}

        <div class="text-center my-10">
            <button type="submit" name="action" value="confirm" class="px-8 py-3 bg-green-600 text-white text-lg font-semibold rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 mx-2">Confirm</button>
            <button type="button" name="action_delete" class="px-8 py-3 bg-red-600 text-white text-lg font-semibold rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 mx-2">Delete</button>
            {# Reparse ë²„íŠ¼ ì¶”ê°€ #}
            <button type="button" id="reparseButton" class="px-8 py-3 bg-gray-600 text-white text-lg font-semibold rounded-lg hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 mx-2">Reparse</button>
        </div>
    </form>
</div> {# End of mainContentArea #}

{# PDF ì‚¬ì´ë“œë°” HTML #}
<div id="pdfSidebar" class="fixed top-0 right-0 h-full w-full sm:w-3/4 md:w-1/2 lg:w-1/3 bg-white shadow-xl transform translate-x-full transition-transform duration-300 ease-in-out z-50 p-4 flex flex-col">
    <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-200">
        <h2 class="text-xl font-semibold text-gray-800">Document Viewer</h2>
        <button id="closePdfSidebarBtn" type="button" class="text-gray-500 hover:text-gray-800 focus:outline-none text-2xl leading-none p-1 hover:bg-gray-200 rounded-full">
            &times;
        </button>
    </div>

    <div id="pdfContent" class="flex-grow w-full overflow-hidden relative">
        <div id="zoomContainer" class="w-full h-full overflow-auto">
            <img id="pdfImageView" class="hidden" alt="Invoice Preview" />
        </div>
        <p id="pdfPlaceholder" class="text-gray-500 text-sm absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2">Documentë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.</p>
        <div class="absolute bottom-2 left-1/2 -translate-x-1/2 text-gray-500 text-xs pointer-events-none">
            ë§ˆìš°ìŠ¤ íœ ì„ ì‚¬ìš©í•˜ì—¬ ì´ë¯¸ì§€ í¬ê¸°ë¥¼ ì¡°ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </div>
    </div>
</div>
<style>
body {
    transition: padding-right 0.3s ease-in-out;
    overflow-x: hidden;
}
#zoomContainer {
    width: 100%;
    height: 100%;
    cursor: grab;
}
#pdfImageView {
    transform-origin: top left;
    transition: transform 0.1s ease-out;
    user-select: none;
    pointer-events: none;
}
</style>

<script>
    let NO_PDF_DEFAULT_TEXT = 'í‘œì‹œí•  PDF ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.';
    const staticUrlsDataElement = document.getElementById('static-urls-data');
    if (staticUrlsDataElement && staticUrlsDataElement.dataset.noPdfPreviewText) {
        NO_PDF_DEFAULT_TEXT = staticUrlsDataElement.dataset.noPdfPreviewText;
    }

    let mainSidebarWasOpenBeforePdfView = false; // ì™¼ìª½ ë©”ì¸ ì‚¬ì´ë“œë°” ìƒíƒœ ê¸°ì–µ
    let currentActiveDocumentId = null; // ì „ì—­ ë³€ìˆ˜ë¡œ ì„ ì–¸ (ë˜ëŠ” ëª¨ë“ˆ ìŠ¤ì½”í”„ ë“±)

    async function loadJournalFormData(documentId) {
        currentActiveDocumentId = documentId;
        const noMsg  = document.getElementById("noLinesMsg");
        if (noMsg) noMsg.style.display = "none";   // ì²« ì¤„ì´ ìƒê²¼ìœ¼ë©´ ë©”ì‹œì§€ ìˆ¨ê¹€

        console.log(`[loadJournalFormData] Loading data for document ID: ${documentId}`);
        if (!documentId) {
            console.warn("[loadJournalFormData] No documentId provided. Aborting form data load.");
            return;
        }
        try {
            const response = await fetch(`/journal/api/get-data/${documentId}/`);
            if (!response.ok) {
                let errorMsg = `HTTP error! status: ${response.status} for ID: ${documentId}`;
                if(response.status === 404) { errorMsg = `ë¬¸ì„œ ID ${documentId}ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`; }
                console.error(`[loadJournalFormData] ${errorMsg}`);
                throw new Error(errorMsg);
            }
            const data = await response.json();
            console.log("[loadJournalFormData] Data received from API:", data);

            console.log("[loadJournalFormData] Populating form fields...");
            document.getElementById('booking_document_no').value = data.booking_document_no || '';
            document.getElementById('transaction_doc_type').value = data.transaction_doc_type || '';
            document.getElementById('internal_request_no').value = data.internal_request_no || '';
            document.getElementById('transaction_document_date').value = data.transaction_document_date ? data.transaction_document_date.split('T')[0] : '';
            document.getElementById('service_date').value = data.service_date ? data.service_date.split('T')[0] : '';
            document.getElementById('booking_date').value = data.booking_date ? data.booking_date.split('T')[0] : '';
            document.getElementById('closing_period').value = data.closing_period || '';
            const ledgerSelect = document.getElementById('ledger');
            ledgerSelect.value = data.ledger || ledgerSelect.options[0].value;
            document.getElementById('transaction_summary').value = data.transaction_summary || '';

            populateTransactionLines(data);

            document.getElementById('payment_entity_no').value = data.payment_entity_no || '';
            document.getElementById('payment_entity').value = data.payment_entity || '';
            document.getElementById('payment_payer').value = data.payment_payer || '';
            document.getElementById('payment_payee').value = data.payment_payee || '';
            document.getElementById('payment_bank').value = data.payment_bank || '';
            document.getElementById('payment_bic_swift').value = data.payment_bic_swift || '';
            document.getElementById('payment_bank_account_no').value = data.payment_bank_account_no || '';
            document.getElementById('payment_terms').value = data.payment_terms || '';
            document.getElementById('payment_date').value = data.payment_date ? data.payment_date.split('T')[0] : '';
            document.getElementById('payment_counterparty_note').value = data.payment_counterparty_note || '';
            const paymentAlternativeSelect = document.getElementById('payment_alternative');
            if (paymentAlternativeSelect) {
                paymentAlternativeSelect.value = data.payment_alternative || 'No';
            }
            // ğŸ” ìë™ ì±„ì›€: ê¸°ì¡´ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ë¡œì§ìœ¼ë¡œ ë³´ì™„
            if (!data.payment_payee && data.main_trading_partner_role === "issuer") {
                // ë°œí–‰ìê°€ ìƒëŒ€ë°© â†’ ìš°ë¦¬ê°€ ì§€ê¸‰í•´ì•¼ í•˜ë¯€ë¡œ ê·¸ ì •ë³´ë¥¼ ì‚¬ìš©
                document.getElementById('payment_entity_no').value = data.issuer_entity_no || '';
                document.getElementById('payment_entity').value = data.issuer_entity || '';
                document.getElementById('payment_payer').value = data.receiver_entity || 'AB Foundation GmbH';
                document.getElementById('payment_payee').value = data.issuer_entity || '';
                document.getElementById('payment_bank').value = data.issuer_bank || '';
                document.getElementById('payment_bic_swift').value = data.issuer_bic_swift || '';
                document.getElementById('payment_bank_account_no').value = data.issuer_bank_account_no || '';
                document.getElementById('payment_counterparty_note').value =
                `Role 'issuer': ${data.receiver_entity || 'payer'} is receiver (purchase invoice).`;
            }

            console.log("[loadJournalFormData] Form fields populated.");

            const openPdfBtn = document.getElementById('openPdfSidebarBtn');
            const pdfSidebar = document.getElementById('pdfSidebar');

            if (data.uploaded_file_url) {
                if (openPdfBtn) {
                    openPdfBtn.setAttribute('onclick', `showPdf('${data.uploaded_file_url}')`);
                    openPdfBtn.disabled = false;
                    openPdfBtn.title = "View PDF";
                }
                if (pdfSidebar && !pdfSidebar.classList.contains('translate-x-full')) {
                    showPdf(data.uploaded_file_url);
                }
            } else {
                if (openPdfBtn) {
                    openPdfBtn.setAttribute('onclick', `showPdf(null)`);
                    openPdfBtn.disabled = false;
                    openPdfBtn.title = "No PDF available";
                }
                if (pdfSidebar && !pdfSidebar.classList.contains('translate-x-full')) {
                   showPdf(null);
                }
            }

            const journalForm = document.getElementById('accountingJournalForm');
            if (journalForm && documentId) {
                let hiddenDocIdInput = journalForm.querySelector('input[name="document_id"]');
                if (!hiddenDocIdInput) {
                    hiddenDocIdInput = document.createElement('input');
                    hiddenDocIdInput.type = 'hidden';
                    hiddenDocIdInput.name = 'document_id';
                    journalForm.appendChild(hiddenDocIdInput);
                }
                hiddenDocIdInput.value = documentId;
            }
        } catch (error) {
            console.error('[loadJournalFormData] Error during data fetch or processing:', error);
        }
    }

    function populateTransactionLines(data) {
        const requiredLines = Math.max(
            3,
            Array.isArray(data.transaction_details) ? data.transaction_details.length : 0
        );

        // â‘¡ ê¸°ì¡´ DOMì— ë¶€ì¡±í•œ ì¤„ì´ ìˆìœ¼ë©´ <template>ì„ ë³µì œí•´ ì¶”ê°€
        const wrapper = document.getElementById("linesWrap");        // ë¼ì¸ë“¤ì„ ë‹´ëŠ” div
        const tmpl     = document.getElementById("lineTemplate");     // ìˆ¨ê²¨ë‘” <template>
        let currentCnt = wrapper.querySelectorAll("[data-line]").length;

        while (currentCnt < requiredLines) {
            const idx = currentCnt + 1;                  // 1-based
            const node = tmpl.content.cloneNode(true);

            // ìƒˆ ë¼ì¸ ë‚´ë¶€ inputë“¤ì˜ id / name ì¬ì§€ì •
            node.querySelectorAll("[data-field]").forEach((el) => {
                const field = el.dataset.field;          // gl_account_no â‹¯
                el.id   = `line${idx}_${field}`;
                el.name = `lines-${idx-1}-${field}`;     // ë°±ì—”ë“œ ìˆ˜ì§‘ìš©
                el.value = "";
            });
            // í—¤ë” â€œLine Item nâ€ ìˆ˜ì •
            node.querySelector("[data-title]").textContent = `Line Item ${idx}`;
            node.firstElementChild.dataset.line = idx;   // <div data-line="idx">

            wrapper.appendChild(node);
            currentCnt += 1;
        }

        // â‘¢ ëª¨ë“  í•„ë“œ ì´ˆê¸°í™”
        const linesToInitialize = Math.max(currentCnt, requiredLines);
        for (let i = 1; i <= requiredLines; i++) {
            [
                "gl_account_no", "gl_account_desc", "currency", "amount",
                "tax_code", "description", "position",
                "master_type","master_key","master_value","quantity","unit_price",
            ].forEach((f) => {
                const el = document.getElementById(`line${i}_${f}`);
                if (el) el.value = "";
            });
        }

        // â‘£ ë°ì´í„° ì±„ìš°ê¸°
        if (Array.isArray(data.transaction_details)) {
            data.transaction_details.forEach((row, idx) => {
                const i = idx + 1;           // 1-based
                document.getElementById(`line${i}_gl_account_no`).value  = row.gl_account_no || "";
                document.getElementById(`line${i}_gl_account_desc`).value= row.gl_account_description || "";
                document.getElementById(`line${i}_currency`).value       = row.currency || "";
                document.getElementById(`line${i}_amount`).value         = row.amount || "";
                document.getElementById(`line${i}_tax_code`).value       = row.tax_code || "";
                document.getElementById(`line${i}_description`).value    = row.description || "";
                document.getElementById(`line${i}_position`).value = row.position || ""; // <-- position ê°’ì„ ì‚¬ìš©í•˜ë„ë¡ ìˆ˜ì •
            });
        }

        // â˜…â˜…â˜… ë°ì´í„° ì±„ìš°ê¸° ì™„ë£Œ í›„ í•©ê³„ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ í˜¸ì¶œ â˜…â˜…â˜…
        updateDebitCreditTotals();
    }

    function updateDebitCreditTotals() {
        let totalDebit = 0;
        let totalCredit = 0;
        const linesWrapper = document.getElementById('linesWrap');

        if (!linesWrapper) {
            console.error("Element with ID 'linesWrap' not found. Cannot calculate totals.");
            return;
        }

        const lineItems = linesWrapper.querySelectorAll('div[data-line]');

        lineItems.forEach((lineDiv) => {
            // ê° ë¼ì¸ div ë‚´ì—ì„œ amountì™€ position í•„ë“œë¥¼ data-field ì†ì„±ìœ¼ë¡œ ì°¾ìŠµë‹ˆë‹¤.
            const amountInput = lineDiv.querySelector('input[data-field="amount"]');
            const positionSelect = lineDiv.querySelector('select[data-field="position"]'); // selectë¡œ ë³€ê²½ë¨

            if (amountInput && positionSelect) {
                const amount = parseFloat(amountInput.value) || 0;
                const position = positionSelect.value; // "debit" ë˜ëŠ” "credit"

                if (position === 'debit') {
                    totalDebit += amount;
                } else if (position === 'credit') {
                    totalCredit += amount;
                }
            }
        });

        const totalDebitEl = document.getElementById('totalDebit');
        const totalCreditEl = document.getElementById('totalCredit');
        const balanceStatusEl = document.getElementById('balanceStatus');

        // í†µí™” ê¸°í˜¸ëŠ” ì‹¤ì œ í†µí™”ì— ë§ê²Œ ë™ì ìœ¼ë¡œ ì„¤ì •í•˜ê±°ë‚˜, ê³ ì • ê°’ ì‚¬ìš©
        const currencySymbol = "$"; // ë˜ëŠ” ë‹¤ë¥¸ í†µí™” ê¸°í˜¸ (ì˜ˆ: document.getElementById('currency').value + " " )

        if (totalDebitEl) totalDebitEl.textContent = `${currencySymbol}${totalDebit.toFixed(2)}`;
        if (totalCreditEl) totalCreditEl.textContent = `${currencySymbol}${totalCredit.toFixed(2)}`;

        if (balanceStatusEl) {
            if (Math.abs(totalDebit - totalCredit) < 0.0001) {
                balanceStatusEl.textContent = 'Balanced';
                balanceStatusEl.classList.remove('text-red-600');
                balanceStatusEl.classList.add('text-green-600');
            } else {
                balanceStatusEl.textContent = 'Not Balanced';
                balanceStatusEl.classList.remove('text-green-600');
                balanceStatusEl.classList.add('text-red-600');
            }
        }
        console.log(`Totals updated: Debit=${totalDebit.toFixed(2)}, Credit=${totalCredit.toFixed(2)}`);
    }

    document.addEventListener("DOMContentLoaded", () => {
        const btnAdd = document.getElementById("btnAddLine");
        const wrap   = document.getElementById("linesWrap");
        const tmpl   = document.getElementById("lineTemplate");

        btnAdd.addEventListener("click", () => {
            const idx = wrap.querySelectorAll("[data-line]").length; // 0-based
            const node = tmpl.content.cloneNode(true);

            node.querySelector("[data-line]").dataset.line = idx;            // data-line ê°±ì‹ 
            node.querySelector("[data-title]").textContent = `Line Item ${idx + 1}`;

            // ëª¨ë“  inputì— idÂ·name ë¶€ì—¬
            node.querySelectorAll("[data-field]").forEach((el) => {
                const field = el.dataset.field; // gl_account_no â€¦
                el.id   = `line${idx + 1}_${field}`;
                el.name = `lines-${idx}-${field}`;
                if (field === "position") el.value = String(idx + 1).padStart(3, "0");
            });

            wrap.appendChild(node);
        });
    });

    function getSidebarWidthPercentage() {
        const screenWidth = window.innerWidth;
        if (screenWidth >= 1024) { return (1/3) * 100; }
        else if (screenWidth >= 768) { return (1/2) * 100; }
        else if (screenWidth >= 640) { return (3/4) * 100; }
        else { return 100; }
    }

    function showPdf(imageUrl) {
        console.log('[showPdf] Called with imageUrl:', imageUrl);
        const pdfViewerSidebar = document.getElementById('pdfSidebar');
        const pdfImageView = document.getElementById('pdfImageView');
        const pdfPlaceholder = document.getElementById('pdfPlaceholder');

        const mainPageSidebar = document.getElementById("sidebar");
        const mainPageWrap = document.getElementById("mainWrapper");
        const mainPageBtnOpen = document.getElementById("btnOpen");

        if (mainPageSidebar && mainPageWrap && mainPageBtnOpen) {
            const isMainPageSidebarOpen = !mainPageSidebar.classList.contains("-translate-x-full");
            if (isMainPageSidebarOpen) {
                mainPageSidebar.classList.add("-translate-x-full", "md:-translate-x-full");
                mainPageWrap.classList.remove("md:ml-64");
                mainPageBtnOpen.classList.remove("hidden");
                mainSidebarWasOpenBeforePdfView = true;
            } else {
                mainSidebarWasOpenBeforePdfView = false;
            }
        } else {
            mainSidebarWasOpenBeforePdfView = false;
        }

        if (pdfViewerSidebar) {
            const sidebarWidthPercent = getSidebarWidthPercentage();
            document.body.style.paddingRight = sidebarWidthPercent + '%';
            document.body.classList.add('pdf-sidebar-open');
            pdfViewerSidebar.classList.remove('translate-x-full');
        }

        if (imageUrl) {
            const cacheBustedUrl = imageUrl + (imageUrl.includes('?') ? '&t=' : '?t=') + new Date().getTime();
            pdfImageView.src = cacheBustedUrl;
            pdfImageView.classList.remove('hidden');
            if (pdfPlaceholder) pdfPlaceholder.classList.add('hidden');
        } else {
            pdfImageView.src = '';
            pdfImageView.classList.add('hidden');
            if (pdfPlaceholder) {
                pdfPlaceholder.textContent = NO_PDF_DEFAULT_TEXT;
                pdfPlaceholder.classList.remove('hidden');
            }
        }
    }

    function closePdfViewerSidebar() {
        console.log('[closePdfViewerSidebar] Called.');
        const pdfViewerSidebar = document.getElementById('pdfSidebar');
        const pdfImageView = document.getElementById('pdfImageView');

        if (pdfViewerSidebar) {
            document.body.style.paddingRight = '0';
            document.body.classList.remove('pdf-sidebar-open');
            pdfViewerSidebar.classList.add('translate-x-full');
            if (pdfImageView) {
                pdfImageView.src = '';
            }
        }

        if (mainSidebarWasOpenBeforePdfView) {
            const mainPageSidebar = document.getElementById("sidebar");
            const mainPageWrap = document.getElementById("mainWrapper");
            const mainPageBtnOpen = document.getElementById("btnOpen");
            if (mainPageSidebar && mainPageWrap && mainPageBtnOpen) {
                mainPageSidebar.classList.remove("-translate-x-full", "md:-translate-x-full");
                mainPageWrap.classList.add("md:ml-64");
                mainPageBtnOpen.classList.add("hidden");
            }
            mainSidebarWasOpenBeforePdfView = false;
        }
    }

    // --- ì—¬ê¸°ê°€ DOMContentLoaded ë¦¬ìŠ¤ë„ˆ ì‹œì‘ì…ë‹ˆë‹¤ ---
    document.addEventListener('DOMContentLoaded', async function () {
        console.log('[DOMContentLoaded] Event fired.');
        const closePdfSidebarBtn = document.getElementById('closePdfSidebarBtn');
        const accountingForm = document.getElementById('accountingJournalForm');
        const pdfSidebarForSubmitListener = document.getElementById('pdfSidebar');
        const openPdfBtn = document.getElementById('openPdfSidebarBtn');
        const pdfImageViewEl = document.getElementById('pdfImageView');
        const pdfPlaceholderEl = document.getElementById('pdfPlaceholder');

        const journalContextEl = document.getElementById('journalContext');
        const currentDocumentIdFromPage = journalContextEl ? journalContextEl.dataset.documentId : null;
        console.log('[DOMContentLoaded] currentDocumentIdFromPage:', currentDocumentIdFromPage);

        const reparseButton = document.getElementById('reparseButton');
        if (reparseButton) {
            reparseButton.addEventListener('click', function(event) {
                console.log('Reparse button clicked.');

                if (!currentActiveDocumentId) { // ì „ì—­ ë³€ìˆ˜ currentActiveDocumentIdë¥¼ ì°¸ì¡°
                    alert('ì¬ë¶„ì„í•  ë¬¸ì„œë¥¼ ë¨¼ì € ì„ íƒ(ë¡œë“œ)í•´ì£¼ì„¸ìš”. (ì˜ˆ: ëª©ë¡ì—ì„œ "To confirm" ë²„íŠ¼ í´ë¦­)');
                    return; // ID ì—†ìœ¼ë©´ ì§„í–‰ ì•ˆ í•¨
                }

                // 1. í¼ì˜ action ì†ì„±ì„ ë™ì ìœ¼ë¡œ ì„¤ì •
                //    Django URL ì´ë¦„ 'journal_entry_form_view'ì— í•´ë‹¹í•˜ëŠ” URL êµ¬ì¡°ë¥¼ ë”°ë¼ì•¼ í•©ë‹ˆë‹¤.
                const formActionUrl = `/journal/entry/${currentActiveDocumentId}/`;
                accountingForm.setAttribute('action', formActionUrl);
                console.log(`Form action set to: ${formActionUrl}`);

                // 2. ì„œë²„ì—ì„œ request.POST.get('action') == 'reparse'ë¡œ í™•ì¸í•˜ê¸° ìœ„í•´
                //    'action'ì´ë¼ëŠ” ì´ë¦„ì˜ hidden input ê°’ì„ 'reparse'ë¡œ ì„¤ì •.
                //    ì´ í•„ë“œê°€ ì´ë¯¸ í¼ì— <button type="submit" name="action" value="reparse"> í˜•íƒœë¡œ
                //    ì¡´ì¬í•˜ê³  Reparse ë²„íŠ¼ì´ type="submit"ì´ë¼ë©´ ì´ ë¶€ë¶„ì€ í•„ìš” ì—†ì„ ìˆ˜ ìˆìœ¼ë‚˜,
                //    type="button"ìœ¼ë¡œ í•˜ê±°ë‚˜ ëª…ì‹œì ìœ¼ë¡œ ê°’ì„ ì„¤ì •í•˜ëŠ” ê²ƒì´ ì•ˆì „í•©ë‹ˆë‹¤.
                let actionInput = accountingForm.querySelector('input[name="action"]');
                if (!actionInput) { // 'action' í•„ë“œê°€ ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
                    actionInput = document.createElement('input');
                    actionInput.type = 'hidden';
                    actionInput.name = 'action';
                    accountingForm.appendChild(actionInput);
                }

                actionInput.value = 'reparse'; // 'reparse' ì•¡ì…˜ ê°’ ì„¤ì •
                console.log('Hidden input "action" set to "reparse".');

                // 3. í¼ì„ ë™ê¸°ì‹ìœ¼ë¡œ ì œì¶œ
                //    ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼ í›„ ì œì¶œ
                yes_no = confirm(`[Reparse Action] ë‹¤ìŒ ë¬¸ì„œ IDë¡œ ì¬ë¶„ì„ ì‘ì—…ì„ ìœ„í•´ í¼ì„ ì œì¶œí•©ë‹ˆë‹¤:\nID: ${currentActiveDocumentId}\nAction URL: ${accountingForm.getAttribute('action')}`);
                if(yes_no){
                    accountingForm.submit();
                }
            });
        }


        if (closePdfSidebarBtn) {
            closePdfSidebarBtn.addEventListener('click', closePdfViewerSidebar);
        }

        if (accountingForm && pdfSidebarForSubmitListener) {
            accountingForm.addEventListener('submit', function(event) {
                if (!pdfSidebarForSubmitListener.classList.contains('translate-x-full')) {
                    sessionStorage.setItem('pdfViewerShouldBeOpen', 'true');
                } else {
                    sessionStorage.removeItem('pdfViewerShouldBeOpen');
                }

                const submitter = event.submitter;
                if (submitter && submitter.name === 'action' && submitter.value === 'confirm') {
                    console.log('[FormSubmit] Confirm button clicked.');

                    // 1. "Balanced" ìƒíƒœ í™•ì¸
                    const balanceStatusEl = document.getElementById('balanceStatus');
                    if (balanceStatusEl && balanceStatusEl.textContent !== 'Balanced') {
                        alert('ì°¨ë³€ê³¼ ëŒ€ë³€ì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤ (Status is Not Balanced).\në¨¼ì € ì”ì•¡ì„ ë§ì¶°ì£¼ì„¸ìš”.');
                        event.preventDefault(); // í¼ ì œì¶œ ì¤‘ë‹¨
                        return;
                    }

                    // 2. í˜„ì¬ ì‘ì—… ëŒ€ìƒ ë¬¸ì„œ ID í™•ì¸ (Reparseì™€ ìœ ì‚¬í•˜ê²Œ)
                    let activeDocumentIdForConfirm = null;
                    if (currentActiveDocumentId) { // loadJournalFormDataì—ì„œ ì„¤ì •ëœ ID ìš°ì„  ì‚¬ìš©
                        activeDocumentIdForConfirm = currentActiveDocumentId;
                    } else if (initialDocumentIdFromPage) { // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° ID ì‚¬ìš©
                        activeDocumentIdForConfirm = initialDocumentIdFromPage;
                    }
                    // í¼ ë‚´ ìˆ¨ê²¨ì§„ document_id í•„ë“œì—ì„œë„ ê°€ì ¸ì˜¬ ìˆ˜ ìˆìŒ (loadJournalFormDataì—ì„œ ì„¤ì •í–ˆë‹¤ë©´)
                    const hiddenDocIdField = accountingForm.querySelector('input[name="document_id"]');
                    if (!activeDocumentIdForConfirm && hiddenDocIdField && hiddenDocIdField.value) {
                        activeDocumentIdForConfirm = hiddenDocIdField.value;
                    }

                    if (!activeDocumentIdForConfirm) {
                        alert('ì˜¤ë¥˜: Confirm ì‘ì—…ì„ ìœ„í•œ ë¬¸ì„œ IDë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¬¸ì„œë¥¼ ë‹¤ì‹œ ë¡œë“œí•´ì£¼ì„¸ìš”.');
                        event.preventDefault(); // í¼ ì œì¶œ ì¤‘ë‹¨
                        return;
                    }

                    // 3. í¼ì˜ action ì†ì„±ì„ ë™ì ìœ¼ë¡œ ì„¤ì •
                    //    (Reparseì™€ ë™ì¼í•œ URL êµ¬ì¡° ë° ë·°ë¥¼ ì‚¬ìš©í•œë‹¤ê³  ê°€ì •)
                    const formActionUrl = `/journal/entry/${activeDocumentIdForConfirm}/`;
                    accountingForm.setAttribute('action', formActionUrl);
                    console.log(`[Confirm Submit] Form action set to: ${formActionUrl}`);

                    // 4. ì‚¬ìš©ìì—ê²Œ ìµœì¢… í™•ì¸ (confirm ì°½)
                    const confirmationMessage = `[Confirm Action]\në‹¤ìŒ ë¬¸ì„œ IDì— ëŒ€í•´ Confirm ì‘ì—…ì„ ì§„í–‰í•˜ê³  í¼ì„ ì œì¶œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nID: ${activeDocumentIdForConfirm}\nAction URL: ${accountingForm.getAttribute('action')}`;

                    if (window.confirm(confirmationMessage)) {
                        // ì‚¬ìš©ìê°€ "í™•ì¸"ì„ ëˆŒë €ì„ ê²½ìš°
                        console.log('[Confirm Submit] User confirmed. Proceeding with form submission.');

                        // --- ê¸°ì¡´ Confirm ê´€ë ¨ sessionStorage ë¡œì§ (ì œì¶œ ì§ì „ì— ìˆ˜í–‰) ---
                        if (pdfSidebarForSubmitListener && !pdfSidebarForSubmitListener.classList.contains('translate-x-full')) {
                            sessionStorage.setItem('pdfViewerShouldBeOpen', 'true');
                        } else {
                            sessionStorage.removeItem('pdfViewerShouldBeOpen');
                        }
                        sessionStorage.setItem('formShouldRefresh', 'true');
                        if (activeDocumentIdForConfirm) {
                            sessionStorage.setItem('docIdForRefresh', activeDocumentIdForConfirm);
                            console.log('[FormSubmit] Storing docIdForRefresh for Confirm:', activeDocumentIdForConfirm);
                        }
                        // --- sessionStorage ë¡œì§ ë ---

                        // í¼ì€ ìë™ìœ¼ë¡œ ì œì¶œë©ë‹ˆë‹¤ (event.preventDefault()ê°€ í˜¸ì¶œë˜ì§€ ì•Šì•˜ìœ¼ë¯€ë¡œ).
                        // ë§Œì•½ ì—¬ê¸°ì„œ ì¶”ê°€ì ì¸ ë¹„ë™ê¸° ì‘ì—… í›„ ì œì¶œí•˜ê³  ì‹¶ë‹¤ë©´,
                        // event.preventDefault()ë¥¼ í˜¸ì¶œí•˜ê³ , ëª¨ë“  ì‘ì—… ì™„ë£Œ í›„ accountingForm.submit()ì„ ëª…ì‹œì ìœ¼ë¡œ í˜¸ì¶œí•´ì•¼ í•©ë‹ˆë‹¤.
                        // í˜„ì¬ëŠ” ì¶”ê°€ ì‘ì—…ì´ ì—†ìœ¼ë¯€ë¡œ, ì´ëŒ€ë¡œ ë‘ë©´ í¼ì´ ì œì¶œë©ë‹ˆë‹¤.
                    } else {
                        // ì‚¬ìš©ìê°€ "ì·¨ì†Œ"ë¥¼ ëˆŒë €ì„ ê²½ìš°
                        console.log('[Confirm Submit] User cancelled.');
                        event.preventDefault(); // â˜…â˜…â˜… í¼ ì œì¶œ ì¤‘ë‹¨ â˜…â˜…â˜…
                        return;
                    }

                    sessionStorage.setItem('formShouldRefresh', 'true');
                    let docIdToStore = currentDocumentIdFromPage;
                    if (!docIdToStore) {
                        const hiddenIdField = accountingForm.querySelector('input[name="document_id"]');
                        if(hiddenIdField && hiddenIdField.value) {
                            docIdToStore = hiddenIdField.value;
                        }
                    }
                    if (docIdToStore) {
                        sessionStorage.setItem('docIdForRefresh', docIdToStore);
                        console.log('[FormSubmit] Storing docIdForRefresh:', docIdToStore);
                    } else {
                         console.warn('[FormSubmit] No document ID available to store for refresh.');
                    }
                } else {
                    sessionStorage.removeItem('formShouldRefresh');
                    sessionStorage.removeItem('docIdForRefresh');
                }
            });
        }

        const linesWrapper = document.getElementById('linesWrap');

        // ì´ë²¤íŠ¸ ìœ„ì„ì„ ì‚¬ìš©í•˜ì—¬ ë¼ì¸ ì•„ì´í…œ ë‚´ì˜ amount ë˜ëŠ” position ë³€ê²½ ê°ì§€
        if (linesWrapper) {
            linesWrapper.addEventListener('input', function(event) { // 'input' ì´ë²¤íŠ¸ëŠ” ê°’ ë³€ê²½ ì¦‰ì‹œ ê°ì§€
                if (event.target.matches('input[data-field="amount"]')) {
                    console.log('Line item Amount changed, recalculating totals.');
                    updateDebitCreditTotals();
                }
            });
            linesWrapper.addEventListener('change', function(event) { // 'change' ì´ë²¤íŠ¸ëŠ” focus ìƒì„ ë•Œ ë˜ëŠ” select ë³€ê²½ ì‹œ
                if (event.target.matches('select[data-field="position"]')) { // 'position' í•„ë“œê°€ selectë¡œ ë³€ê²½ë¨
                    console.log('Line item Position changed, recalculating totals.');
                    updateDebitCreditTotals();
                }
            });
        }

        let initialPdfUrlFromDjango = null;
        {% if document_data and document_data.uploaded_file_url %}
            initialPdfUrlFromDjango = "{{ document_data.uploaded_file_url|escapejs }}";
        {% endif %}
        console.log('[DOMContentLoaded] initialPdfUrlFromDjango:', initialPdfUrlFromDjango);

        if (openPdfBtn) {
            if (initialPdfUrlFromDjango) {
                openPdfBtn.setAttribute('onclick', `showPdf('${initialPdfUrlFromDjango}')`);
                openPdfBtn.disabled = false;
            } else {
                openPdfBtn.setAttribute('onclick', `showPdf(null)`);
                openPdfBtn.disabled = false;
            }
        }

        if (pdfImageViewEl) pdfImageViewEl.classList.add('hidden');
        if (pdfPlaceholderEl) {
            pdfPlaceholderEl.textContent = "Documentë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.";
            pdfPlaceholderEl.classList.remove('hidden');
        }

        const formShouldRefresh = sessionStorage.getItem('formShouldRefresh');
        const docIdForRefresh = sessionStorage.getItem('docIdForRefresh');
        let pdfUrlAfterFormRefresh = initialPdfUrlFromDjango; // ê¸°ë³¸ê°’

        if (formShouldRefresh === 'true' && docIdForRefresh) {
            console.log(`[DOMContentLoaded] Refreshing form data for doc ID: ${docIdForRefresh}`);
            await loadJournalFormData(docIdForRefresh); // ì´ í•¨ìˆ˜ëŠ” ë‚´ë¶€ì ìœ¼ë¡œ PDF ë²„íŠ¼ì˜ onclickë„ ì—…ë°ì´íŠ¸ í•  ìˆ˜ ìˆìŒ
            sessionStorage.removeItem('formShouldRefresh');
            sessionStorage.removeItem('docIdForRefresh');
            console.log('[DOMContentLoaded] Cleared form refresh flags.');
            // loadJournalFormData í›„ openPdfBtnì˜ onclickì´ ìµœì‹  PDF URLë¡œ ì—…ë°ì´íŠ¸ ë˜ì—ˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ê·¸ ê°’ì„ ì‚¬ìš©
            if (openPdfBtn && openPdfBtn.getAttribute('onclick')) {
                const onclickAttr = openPdfBtn.getAttribute('onclick');
                const match = onclickAttr.match(/showPdf\(['"](.*?)['"]\)/);
                if (match && match[1] && match[1] !== 'null') {
                    pdfUrlAfterFormRefresh = match[1];
                } else if (match && match[1] === 'null') {
                    pdfUrlAfterFormRefresh = null;
                }
            }
        }

        const pdfViewerShouldBeOpen = sessionStorage.getItem('pdfViewerShouldBeOpen');
        if (pdfViewerShouldBeOpen === 'true') {
            console.log('[DOMContentLoaded] Auto-reopening PDF viewer with URL:', pdfUrlAfterFormRefresh);
            showPdf(pdfUrlAfterFormRefresh); // í¼ ìƒˆë¡œê³ ì¹¨ í›„ì˜ ìµœì‹  PDF URL ì‚¬ìš©
            sessionStorage.removeItem('pdfViewerShouldBeOpen');
        }

        // --- Zoom and Pan ìŠ¤í¬ë¦½íŠ¸ë¥¼ DOMContentLoaded ë‚´ë¡œ ì´ë™ ---
        console.log("[DOMContentLoaded] Initializing Zoom/Pan script...");
        let zoom = 1;
        // let originX = 0; // originX, YëŠ” í˜„ì¬ ì‚¬ìš©ë˜ì§€ ì•Šìœ¼ë¯€ë¡œ ì£¼ì„ ì²˜ë¦¬ ë˜ëŠ” ì œê±° ê°€ëŠ¥
        // let originY = 0;
        let isDragging = false;
        let startX_drag, startY_drag, scrollLeft_drag, scrollTop_drag; // ë³€ìˆ˜ëª… ë³€ê²½ (ìƒìœ„ ìŠ¤ì½”í”„ì™€ ì¶©ëŒ ë°©ì§€)

        const zoomContainer = document.getElementById('zoomContainer');
        const pdfImageForZoom = document.getElementById('pdfImageView'); // ë³€ìˆ˜ëª… ë³€ê²½

        console.log("[Zoom/Pan] zoomContainer:", zoomContainer);
        console.log("[Zoom/Pan] pdfImageForZoom:", pdfImageForZoom);

        if (zoomContainer && pdfImageForZoom) {
            zoomContainer.addEventListener('wheel', (e) => {
                console.log("[Zoom/Pan] Wheel event fired on zoomContainer. DeltaY:", e.deltaY);
                e.preventDefault();
                const delta = e.deltaY > 0 ? -0.1 : 0.1;
                zoom = Math.min(Math.max(0.5, zoom + delta), 5); // 0.5x ~ 5x ì œí•œ
                pdfImageForZoom.style.transform = `scale(${zoom})`;
                console.log("[Zoom/Pan] Image scaled to:", zoom);
            });

            zoomContainer.addEventListener('mousedown', (e) => {
                console.log("[Zoom/Pan] Mouse down on zoomContainer.");
                isDragging = true;
                startX_drag = e.pageX - zoomContainer.offsetLeft;
                startY_drag = e.pageY - zoomContainer.offsetTop;
                scrollLeft_drag = zoomContainer.scrollLeft;
                scrollTop_drag = zoomContainer.scrollTop;
                zoomContainer.style.cursor = 'grabbing';
            });

            zoomContainer.addEventListener('mouseleave', () => {
                if (isDragging) {
                    console.log("[Zoom/Pan] Mouse leave while dragging.");
                    isDragging = false;
                    zoomContainer.style.cursor = 'grab';
                }
            });

            zoomContainer.addEventListener('mouseup', () => {
                if (isDragging) {
                    console.log("[Zoom/Pan] Mouse up.");
                    isDragging = false;
                    zoomContainer.style.cursor = 'grab';
                }
            });

            zoomContainer.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                e.preventDefault();
                const x = e.pageX - zoomContainer.offsetLeft;
                const y = e.pageY - zoomContainer.offsetTop;
                const walkX = x - startX_drag;
                const walkY = y - startY_drag;
                zoomContainer.scrollLeft = scrollLeft_drag - walkX;
                zoomContainer.scrollTop = scrollTop_drag - walkY;
            });
            console.log("[Zoom/Pan] Event listeners attached.");
        } else {
            console.error("[Zoom/Pan] zoomContainer or pdfImageView not found! Zoom/Pan will not work.");
        }
        // --- Zoom and Pan ìŠ¤í¬ë¦½íŠ¸ ë ---
    });
    // --- DOMContentLoaded ë¦¬ìŠ¤ë„ˆ ë ---
</script>